<HTML>
<HEAD>
<TITLE> Bi-Residue code </TITLE>
<SCRIPT language="JavaScript">
//Author zwo @ 12.27,2004
display_info = "" ;
predict_error_data=0;
predict_error_C1=0;
predict_error_C2=0;

function ResetInput(form) {
	form.checked_baseA.value = ""
	form.checked_baseB.value = ""	
	form.dataWord.value = ""
	form.encodedWord.value = ""
	form.decoded_Word.value = ""
	form.detect_error.value = ""
	form.correct_error.value = ""
	form.received_Word.value = ""
	form.data_bit_number.value=""
	form.faulty_free_data.value="";
	form.faulty_free_R1.value="";
	form.faulty_free_R2.value="";
	form.faulty_data.value="";
	form.faulty_free_d.value="";
	form.decoded_dec_word.value="";
}

function default_input(form){
	form.checked_baseA.value="2";
	form.checked_baseB.value="3";
	form.dataWord.value="11";
	form.data_bit_number.value="6";
	form.encodedWord.value="";
	form.decoded_Word.value="";
	form.detect_error.value="";
	form.correct_error.value="";
	form.received_Word.value="";
	form.faulty_free_data.value="";
	form.faulty_free_R1.value="";
	form.faulty_free_R2.value="";
	form.faulty_data.value="";
	form.faulty_free_d.value="";
	form.decoded_dec_word.value="";
}

function display_function(){
  //open a new window for display infos
  new_window=window.open("", "", "scrollbars=yes, resizable=yes, width=600, height=200");
  new_window.opener=self;
  new_window.document.open();
  new_window.document.write("<HTML><HEAD><TITLE>display the infomations</TITLE></head>");
  new_window.document.write(display_info);
  new_window.document.write("</BODY></HTML>");
  new_window.document.close();
}

function check_lcm(nbit_data, nbit_C1, nbit_C2){
//check for lcm relations, currently only deals with nbit_data=6 || 24
// if (6,2,3) return case 1
//    (24,3,8) return case 2
//    not with LCM relations, return -1
//    with LCM relations, but other case, such as (6,2,6), return 0
  if(nbit_data%nbit_C1!=0 || nbit_data%nbit_C2!=0){
  	return -1;
  }
  else if(nbit_C1*nbit_C2<nbit_data) return -1;
  if(nbit_data==6){
    if(nbit_C1==2 && nbit_C2==3) return 1;
    else	return 0;
  }
  else{
    if(nbit_C1==3 && nbit_C2==8) return 2;
    else 	return 0;
  }
}

function encode(form){
  nbit_data=parseInt(form.data_bit_number.value);
  if(nbit_data!=6 && nbit_data !=24){
  	alert(" input bit number for k!=6 or 24, for our demo, it's not allowed!");
  	display_function();
  	default_input(this.form);
  	return;
  }
  D_word=parseInt(form.dataWord.value);
  nbit_C1=parseInt(form.checked_baseA.value);
  nbit_C2=parseInt(form.checked_baseB.value);
  //check D_word if overflow or not
  if(D_word>Math.pow(2,nbit_data)-1){
  	alert(" input data-bit out-of range, re-input please");
  	ResetInput(form);
  	default_input(form);
  	return;
  }
  //check for the LCM(c,d)=k relations
  if(nbit_C1<=0 || nbit_C2<=0 || (nbit_C1==nbit_C2)){
  	alert("input bit number for (k,c,d) errors");
  	ResetInput(form);
  	default_input(form);
  	return;
  }
  else if(nbit_C1>nbit_C2){
  	//alert("input number for c>d, for our symmetry reason, we swap c,d");
  	temp=nbit_C1;
  	nbit_C1=nbit_C2;
  	nbit_C2=temp;
  	temp=form.checked_baseA.value;
  	form.checked_baseA.value=form.checked_baseB.value;
  	form.checked_baseB.value=temp;
  }
  return_value=check_lcm(nbit_data,nbit_C1,nbit_C2);
  switch(return_value){
    case -1:
  	alert("input bit for (k,c,d) violation! re-input c,d");
  	return;
  	break;
    case 0:
    	alert("though input for (k,c,d) valid, but not efficient, reinput please");
    	return;
    	break;
  }
  C1_word=Math.pow(2,nbit_C1)-1;
  C2_word=Math.pow(2,nbit_C2)-1;
  C1_list=new Array(nbit_C1);
  C2_list=new Array(nbit_C2);
  data_list=new Array(nbit_data);
  Residue_C1=D_word%C1_word;
  Residue_C2=D_word%C2_word;
  form.faulty_free_R1.value=Residue_C1;
  form.faulty_free_R2.value=Residue_C2;
  form.faulty_free_data.value=D_word;
  Residue_bin_C1=convert_bin(Residue_C1,nbit_C1, C1_list);
  Residue_bin_C2=convert_bin(Residue_C2,nbit_C2, C2_list);
  D_bin_word=convert_bin(D_word, nbit_data, data_list);
  form.encodedWord.value=D_bin_word + " , " + Residue_bin_C1 + " , " + Residue_bin_C2;
  form.received_Word.value=D_bin_word + Residue_bin_C1 + Residue_bin_C2;
  var received_string=form.received_Word.value;  
  var d_list=new Array(form.received_Word.value.length);
  for(i=0; i<form.received_Word.value.length; i++)
  	d_list[form.received_Word.value.length-i-1]=parseInt(received_string.substring(i,i+1));
  form.faulty_free_d.value=convert_dec(d_list, form.received_Word.value.length);
}

function ResetDecode(form){
  	form.received_Word.value=D_bin_word + Residue_bin_C1 + Residue_bin_C2;
  	form.decoded_Word.value="";
  	form.detect_error.value="";
  	form.correct_error.value="";
  	form.faulty_data.value="";
  	form.decoded_dec_word.value="";
}

function decode(form){
  form.decoded_Word.value="";
  form.detect_error.value="";
  form.correct_error.value="";
  //form.faulty_data.value="";
  form.decoded_dec_word.value="";
  var received_string;
  received_string=form.received_Word.value;
  if(form.received_Word.value.length!=nbit_data+nbit_C1+nbit_C2){
  	alert("received string length error! re-injection please");
  	//do clear and re-start from the encoded process
  	ResetDecode(form);
  	return;
  }
  received_data_list=new Array(nbit_data);
  received_C1_list=new Array(nbit_C1);
  received_C2_list=new Array(nbit_C2);
  for(i=0; i<nbit_data; i++)
  	received_data_list[nbit_data-i-1]=parseInt(received_string.substring(i,i+1));
  for(i=0; i<nbit_C1; i++)
  	received_C1_list[nbit_C1-i-1]=parseInt(received_string.substring(i+nbit_data,i+nbit_data+1));
  for(i=0; i<nbit_C2; i++)
  	received_C2_list[nbit_C2-i-1]=parseInt(received_string.substring(i+nbit_data+nbit_C1,i+nbit_data+nbit_C1+1));
  //compare for the error bit inserted!
  var error_bit_num=0;
  for(i=0; i<nbit_data; i++)
  	if(data_list[i]!=received_data_list[i]) error_bit_num++;
  for(i=0; i<nbit_C1; i++)
  	if(C1_list[i]!=received_C1_list[i]) error_bit_num++;
  for(i=0; i<nbit_C2; i++)
  	if(C2_list[i]!=received_C2_list[i]) error_bit_num++;
  //if(error_bit_num==0)
  //	alert("no fault-bit injected, valid input!");
  //else if(error_bit_num>=2){
  //	alert("more than two fault-bit injected, invalid input!");
  	//should restart from the valid injection points
  	//return;
  //}
  //else 
  //	alert("only one fault-bit injected, valid input!");
  //the next code is for detect & correct the error!
  //step 1: generate received_D_word, received_C1_word, received_C2_word
  received_D_word=convert_dec(received_data_list, nbit_data);
  received_C1_word=convert_dec(received_C1_list, nbit_C1);
  received_C2_word=convert_dec(received_C2_list, nbit_C2);
  //step 2: generate syndromes(abs(D-C1), abs(D-C2)), for our demo, nbit_data=6
  syndrome_C1=(received_D_word-received_C1_word)%C1_word;
  syndrome_C2=(received_D_word-received_C2_word)%C2_word;
  if(syndrome_C1<0) syndrome_C1 += C1_word;
  if(syndrome_C2<0) syndrome_C2 += C2_word;
  //step 3: judge & correct error
  // in order to use switch and judge, I first generate a featured string
  var featured_syndrome="";
  featured_syndrome=syndrome_C1 + "_" + syndrome_C2;
  display_info="received_data_string=<b>" + received_string.substring(0,nbit_data) + "</b>, received_C1_string=<b>" + 
  	received_string.substring(nbit_data,nbit_data+nbit_C1) +
  	"</b>, received_C2_string=<b>" + received_string.substring(nbit_data+nbit_C1,nbit_data+nbit_C1+nbit_C2) + "</b>";
  display_info += "<BR> the syndrome for received stream is : <font color=red> (" + syndrome_C1 + " , " + syndrome_C2 + ")</font><br>";
  form.detect_error.value="yes";
  if(syndrome_C1 ==0 && syndrome_C2==0){
  	form.detect_error.value="no";
  	form.correct_error.value="no";
  	display_info += " <b><font color=blue> no errors </font></b>";
  }
  else if(syndrome_C1==0){
  	display_info += " <b><font color=blue> errors in checkbit C2 </font></b>";
  	form.correct_error.value="yes";
  }
  else if(syndrome_C2==0){
  	display_info += " <b><font color=blue> errors in checkbit C1 </font></b>";
  	form.correct_error.value="yes";
  }
  else{
   form.correct_error.value="yes";
   if(nbit_data==6){
   switch(featured_syndrome){
    case "1_1" :
    	display_info += " <b><font color=red> error in data, bit 0, 0-->1 error </fone></b> ";
    	if(received_data_list[0]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[0]=0;
    	break;
    case "2_2" :
    	display_info += " <b><font color=red> error in data, bit 1, 0-->1 error </fone></b> ";
    	if(received_data_list[1]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[1]=0;
    	break;
    case "1_4" :
    	display_info += " <b><font color=red> error in data, bit 2, 0-->1 error </fone></b> ";
    	if(received_data_list[2]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[2]=0;
    	break;
    case "2_1" :
    	display_info += " <b><font color=red> error in data, bit 3, 0-->1 error </fone></b> ";
    	if(received_data_list[3]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[3]=0;
    	break;
    case "1_2" :
    	display_info += " <b><font color=red> error in data, bit 4, 0-->1 error </fone></b> ";
    	if(received_data_list[4]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[4]=0;
    	break;
    case "2_4" :
    	display_info += " <b><font color=red> error in data, bit 5, 0-->1 error </fone></b> ";
    	if(received_data_list[5]==0){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[5]=0;
    	break;
    case "2_6" :
    	display_info += " <b><font color=red> error in data, bit 0, 1-->0 error </fone></b> ";
    	if(received_data_list[0]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[0]=1;
    	break;
    case "1_5" :
    	display_info += " <b><font color=red> error in data, bit 1, 1-->0 error </fone></b> ";
    	if(received_data_list[1]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[1]=1;
    	break;
    case "2_3" :
    	display_info += " <b><font color=red> error in data, bit 2, 1-->0 error </fone></b> ";
    	if(received_data_list[2]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[2]=1;
    	break;
    case "1_6" :
    	display_info += " <b><font color=red> error in data, bit 3, 1-->0 error </fone></b> ";
    	if(received_data_list[3]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[3]=1;
    	break;
    case "2_5" :
    	display_info += " <b><font color=red> error in data, bit 4, 1-->0 error </fone></b> ";
    	if(received_data_list[4]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[4]=1;
    	break;
    case "1_3" :
    	display_info += " <b><font color=red> error in data, bit 5, 1-->0 error </fone></b> ";
    	if(received_data_list[5]==1){
    	  display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  form.correct_error.value="no";
    	}
    	else
    	  received_data_list[5]=1;
    	break;
    default:
    	display_info += "<b><font color=blue> un-recognized syndromes </font> </b> ";
    	form.correct_error.value="no";
   }  //end switch
   }  //end if for nbit_data==6
   else { // for nbit_data=24, because the syndrome case is too big, I cheat it as normal comparison method.
   	//if error_bit_num=0, then no error; =1, can use the following judgement, >1, then error predict
   	if(error_bit_num==0)
   		display_info += "<font color=red> no error found </font>";
   	else if(error_bit_num==1){
     	for(i=0; i<nbit_data; i++){
     	  if(data_list[i]!=received_data_list[i]){
     	  	if(data_list[i]==0){ //0->1 error
     	  	  display_info += "<font color=red> error in data, bit <b>" + i + ", 0-->1 error </font></b>";
     	  	  received_data_list[i]=0;
     	  	}
     	  	else{
     	  	  display_info += "<font color=red> error in data, bit <b>" + i + ", 1-->0 error </font></b>";
     	  	  received_data_list[i]=1;
     	  	}
     	  	break;
     	  }
     	}
     	}//end else if
     	else{	//error_bit_num>1
     	  //the straitegy is: since the code cannot be correctly decoded, we make a random judge and correct
     	  var random_position=(syndrome_C1+syndrome_C2)%nbit_data;
     	  if(received_data_list[random_position]==1){	//0-->1 error assumed
     	  	display_info += "<font color=red> error in data, bit <b>" + random_position + ", 0-->1 error </font></b>";
     	  	if(received_data_list[random_position]==0){
    	  		display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  		form.correct_error.value="no";
    		}
    		else
     	  		received_data_list[random_position]=0;
     	  }
     	  else{
     	  	display_info += "<font color=red> error in data, bit <b>" + random_position + ", 1-->0 error </font></b>";
     	  	if(received_data_list[random_position]==1){
    	  		display_info += "<br><b><font color=blue> multi-bit error, cannot correct </font></b>";
    	  		form.correct_error.value="no";
    		}
    		else
     	  		received_data_list[random_position]=1;
     	  }
     	} //end else for error_bit_num
    } // end else for nbit_data=24 
  } //end else
  var msj_tmp=convert_dec(received_data_list,nbit_data);
  form.decoded_Word.value=convert_bin(msj_tmp, nbit_data, received_data_list);
  //the last step, just display the corrected stream
  display_info += "<br> correct_data_stream is <b>:" + form.decoded_Word.value + "</b>";
  form.decoded_dec_word.value=msj_tmp;
  //form.decoded_Word.value=D_bin_word;
} 

function convert_dec(myarray, nbit){
//given the string, get the conversion to dec
  data=0;
  for(i=0; i< nbit; i++)
	data += Math.pow(2,i)*myarray[i];
  return data;
}
  

function convert_bin(data, nbit, the_list){
  //returns the string for the data
  var convert_str="";
  for(i=0; i<nbit; i++){
    var cur_bit = data%2;
    data = Math.floor(data/2);
    convert_str = cur_bit + convert_str;
    the_list[i]=cur_bit;
  }
  return(convert_str);
}

function correspond(form){
  //return the dec-value for the  received_Word.value
  //and assign to var form.faulty_data.value
  var received_string;
  received_string=form.received_Word.value;  
  var d_list=new Array(form.received_Word.value.length);
  for(i=0; i<form.received_Word.value.length; i++)
  	d_list[form.received_Word.value.length-i-1]=parseInt(received_string.substring(i,i+1));
  form.faulty_data.value=convert_dec(d_list, form.received_Word.value.length);
}

</SCRIPT>
</HEAD>

<BODY bgcolor="#EAEAAE" text="black">
<FONT size=+3><B>Bi-Residue Simulator
</B></FONT><BR><A href="biresiduecode_help.html"><FONT 
color=#0000ff>Help and Information</FONT></A> 
<hr>
<FORM>
<TABLE><FONT size=+2><font color=green>Bi-Residue Encoder Part:</font></FONT> 
  <TBODY>
  <TR>
    <TD><B>Data word(DEC): </B><INPUT name=dataWord value=11 size=6>  <br>
    <b> Data bit number(<font color=red>k</font>), for our demo,only <font color=red>k=6</font> or <font color=red>k=24</font> allowed: 
    </b> <input name=data_bit_number value=6 size=2> <BR>
    <B>Check base-A bit number(<font color=red>c</font>): </B><INPUT name=checked_baseA value=2 size=1> 
    <B>Check base-B bit number(<font color=red>d</font>): </B><input name=checked_baseB value=3 size=1> <BR><br>
    &nbsp&nbsp&nbsp&nbsp<font color=red size=+1><b> requirement: k=LCM(c,d)</b></font><br><br>
    <B><INPUT onclick=encode(this.form) type=button value="Encode ->" name=enter1> 
    &nbsp <B>Encoded word turple (x,y,z):</B><INPUT name=encodedWord size=60> <br>
    corresponding faulty_free data (DEC) : data <input name=faulty_free_data size=6> &nbsp R1 <input name=faulty_free_R1 size=2> &nbsp R2
    <input name=faulty_free_R2 size=2>
    &nbsp string_data <input name=faulty_free_d size=6></TD></TBODY></TABLE>
<hr>

<hr>
<form>
<Table cellpadding=10><font size=+2 color=green>Bi-Residue Decoder Part:</font>
  <tbody><tr>
    <td><B>received word(fault injection here): </b><input name=received_Word size=60> <br>
    <b><input onclick=correspond(this.form) type=button value="corresponding faulty data->" name=enter3>
    (DEC): string_data <input name=faulty_data size=6> </b> <br><br>
    <b><input onclick=decode(this.form) type=button value="Decode ->" name=enter2>
    <B>Decoded word:</b><input name=decoded_Word size=30> 
    <b>&nbsp dec:<input name=decoded_dec_word size=6><br><br>
    <b>Detected error: </b> <input name=detect_error type="text" size=4 > 
    <b>Corrected error: </b> <input name=correct_error type="text" size=4 > <br>
    <b><font color=red><input type=button value="Info window, click on me!" name=enter3 onclick=display_function()></font><br>
    </td></tbody></table>
<hr>
<input type="button" value="Reset Decode Fields" name="btnDecod" onClick="ResetDecode(this.form)">
<input type="button" value="Reset  All Fields" name="btnReset" onClick="ResetInput(this.form)">
<input type="button" value="Default Fields"  name="btDfault" onclick="default_input(this.form)">
</form>
</body>
</html>
