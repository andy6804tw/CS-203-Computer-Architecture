<HTML>
<HEAD>
<TITLE> Ripple Carry Adder With Timing</TITLE>
<SCRIPT language="JavaScript">

function MakeLine(NumColumns) 
{
	return "<TR> <TD colspan=" + NumColumns + "> <HR noshade size=1>\n";
}

function PrintError(Message) 
{
	Error = "<CENTER><H1> ERROR </H1></CENTER> <P>\n"
	Error += "<CENTER> <EM>" + Message + "</EM> </CENTER>\n"
	return Error
}

function IsInteger(Num) 
{
	return (Num == Math.floor(Num))
}

function OrderOfMagnitude (TheNum) 
{
	// returns the highest place which has a "1" in TheNum's
	// binary representation

	// to account for 2's complement representation...
	//alert ("TheNum is now " + TheNum)
	TheNum < 0 ? TheNum = (TheNum * -2) - 2 : TheNum *= 2
	//alert ("TheNum is now " + TheNum)

	LogBaseTwo = Math.log(TheNum)/Math.LN2;
	return Math.floor(LogBaseTwo)
}

function ParseBinary (BinNum) 
{
	// Turns a binary number into a decimal, sets a flag to true if
	// BinNum is not actually binary

	IsNeg = false
	if (BinNum < 0) 
	{
		IsNeg = true
		BinNum *= -1
	}
	RealNum = 0
	BinNum += Math.pow(10, -1 - NumBits) // kludge so processor
					     // won't mess up
	LogBaseTen = Math.log(BinNum)/Math.LN10
	HighestPlace = Math.ceil(LogBaseTen)
	for (CurPlace = HighestPlace; CurPlace >= -NumBits; CurPlace--) 
	{
		CurEntry = Math.floor(BinNum / Math.pow(10, CurPlace))
		if (CurEntry != 0 && CurEntry != 1) 
		{
			NotBinary = true
			CurEntry = 1 // feed it something normal, to avoid
					 // wierd Javascript errors
		}
		if (CurEntry == 1) 
		{
			RealNum += Math.pow(2, CurPlace)
			BinNum -= Math.pow(10, CurPlace)
		}
	}
	if (IsNeg) {RealNum *= -1} // reverse it back at the end

	// now check if the number was negative according to two's complement
	// representation - if it was, set the decimal value to this negative
	// number
	if (HighestPlace == NumBits)
		RealNum -= Math.pow(2, NumBits)

	// if (HighestPlace == 1)
	// 	RealNum -= Math.pow(2, 1)

	return RealNum
}

function RoundOff (TheNum) 
{
	// returns the value TheNum would have if it were represented by
	// NumDecimals bits after the decimal point
	Scaling = Math.pow(2, NumDecimals)
	return (Math.floor(TheNum * Scaling) / Scaling)
}



function PrintTwosComp(TheNum, StartPlace) 
{

	// first deal with negative numbers...
	if (TheNum < 0) {TheNum += Math.pow(2, StartPlace)}

	// now initialize the string
	S = "";
	S += "<TD> ";
	for (CurPlace = StartPlace - 1; CurPlace >= -NumDecimals; CurPlace--) 
	{
		if (CurPlace == -1) 
		{
			S += ".";
		}
		CurPower = Math.pow(2, CurPlace);
		if (TheNum >= CurPower) 
		{
			S += "1 ";
			TheNum -= CurPower
		} 
		else 
		{
			S += "0 "
		} 
	}
	return S;
}


function FeedIntoVariable(TheNum, StartPlace, ReturnArray) 
{
	if (TheNum < 0) {TheNum += Math.pow(2, StartPlace)}

	// now initialize the string
	index = StartPlace - 1
	for (CurPlace = StartPlace - 1; CurPlace >= -NumDecimals; CurPlace--) 
	{
		if (CurPlace == -1) 
		{
			ReturnArray[index] = 2;
			index --
		}
		CurPower = Math.pow(2, CurPlace);
		if (TheNum >= CurPower) 
		{
			ReturnArray[index] = 1;
			index --
			TheNum -= CurPower
		} 
		else 
		{
			ReturnArray[index] = 0;
			index --;
		} 
	}
	return ReturnArray
}


function PrintSumCarry(Middle, counter)
{
	Middle += MakeLine(NumCols + 3)
    Middle += "<TR><TD><TD>"
	if (counter == 1)
		Middle += "<TR><TD><h4>Time =  t</h4><TD><TD>"
	else
		Middle += "<TR><TD><h4>Time =  " + counter + "t</h4><TD><TD>"
    Middle += "<TR><TD>Carry     :    <TD><TD>" 
	for (loop=NumDigits-1;loop>=0;loop--)
 		Middle += " " + FinalCarry[loop];
    Middle += "<TR><TD>Sum       :    <TD><TD>"
	for (loop=NumDigits-1;loop>=0;loop--)
		Middle += " " + FinalSum[loop]
	

	return Middle
}


//Next function returns the larger of two numbers
function GetMax(Number1, Number2)
{
	if (Number1 > Number2)
		bigger = Number1
	else
		bigger = Number2

	return bigger
}


//Next function returns the smaller of two numbers
function GetMin(Number1, Number2)
{
	if (Number1 < Number2)
		smaller = Number1
	else
		smaller = Number2

	return smaller
}


//Next function returns the time needed to Calculate the Sum-time of this adder block
function CalculateSumTime(AToSum, CinToSum, PrevCarryTime)
{
	if (PrevCarryTime == 0)
		finalTime = GetMax(AToSum, CinToSum)
	else
	{
		if (CinToSum > AToSum)
			finalTime = PrevCarryTime + CinToSum
		else
		{
			if (PrevCarryTime < AToSum)
			{
				difference = AToSum - CinToSum
				finalTime = GetMax(difference, CinToSum) + PrevCarryTime
			}
			else
				finalTime = CinToSum + PrevCarryTime
		}
	}

	//Cross-checking for trivial case
	if (finalTime < AToSum)
		finalTime = AToSum
	if (finalTime < CinToSum)
		finalTime = CinToSum

	return finalTime	
}


//Next function returns the time needed to Calculate the Carry-time of this adder block
function CalculateCarryTime(AToCout, CinToCout, PrevCarryTime)
{
	if (PrevCarryTime == 0)
		CarryOutTime = GetMax(AToCout, CinToCout)
	else
	{
		if (CinToCout > AToCout)
			CarryOutTime = PrevCarryTime + CinToCout
		else
		{
			if (PrevCarryTime < AToCout)
			{
				difference = AToCout - CinToCout
				CarryOutTime = GetMax(difference, CinToCout) + PrevCarryTime
			}
			else
				CarryOutTime = CinToCout + PrevCarryTime
		}
	}

	//Cross-checking for trivial case
	if (CarryOutTime < AToCout)
		CarryOutTime = AToCout
	if (CarryOutTime < CinToCout)
		CarryOutTime = CinToCout

	return CarryOutTime	
}



function RippleCarryAdd(form) 
{
	TheTop = "<HTML><HEAD><TITLE>Tablet</TITLE></HEAD><BODY bgcolor=white text=black>";
	
	A = parseFloat(form.A.value)
	B = parseFloat(form.B.value)

	CinToSum = parseFloat(form.CinToSum.value)
	AToSum = parseFloat(form.AToSum.value)
	CinToCout = parseFloat(form.CinToCout.value)
	AToCout = parseFloat(form.AToCout.value)


	ChoseBin = form.Base[0].checked
	ChoseDec = form.Base[1].checked
	NumBits = parseInt(form.NumBits.value)
	NotBinary = false
	if (ChoseBin) 
	{
		A = ParseBinary(A)
		B = ParseBinary(B)
	}


	Mixed = false
	Overflow = false
	FractionalNum = (Math.abs(A) < 2) && (Math.abs(B) < 2)
	// bit to left of dec. pt. is sign bit 
	if (IsInteger(A) & IsInteger(B)) 
	{
		NumDecimals = 0
		NumDigits = NumBits
		if (Math.max(OrderOfMagnitude(A), OrderOfMagnitude(B)) + 1 > NumDigits) 
		{
			NumDigits = 0
			NumDecimals = 0
			Overflow = true
		}
	} 
	else 
	{
		if (FractionalNum) 
		{
			NumDigits = 1
			NumDecimals = NumBits - 1
		} 
		else 
		{
			Mixed = true
			NumDigits = 0
			NumDecimals = 0    // just filler values 
		}
	}

	NumCols = (2 * NumDigits - 1) + NumDecimals

	
	A = RoundOff(A)
	B = RoundOff(B)

	Product = 0


	Middle = " "


	// now initialize two Input Arrays & two Output arrays
	FirstNumber = new Array(NumDigits)
	FeedIntoVariable(A, NumDigits,FirstNumber)
	SecondNumber = new Array(NumDigits)
	FeedIntoVariable(B, NumDigits,SecondNumber)
	FinalCarry = new Array(NumDigits)
	FinalSum = new Array(NumDigits)
	
	SumTime = new Array(NumDigits)
	CarryTime = new Array(NumDigits)

		
	for (i=NumDigits-1;i>=0;i--)
	{
		FinalCarry[i] = 0
		FinalSum[i] = FirstNumber[i];
	}
	

	for (counter = NumDecimals; counter < NumDigits; counter++) 
	{
		if (counter==0)
			carryin=0;
		else
			carryin = FinalCarry[counter-1]

		carryout1 = FirstNumber[counter] & SecondNumber[counter];
		carryout2 = carryin & FirstNumber[counter];
		carryout3 = carryin & SecondNumber[counter];
		carryout = carryout1 | carryout2 | carryout3;
		FinalCarry[counter] = carryout	
				
		sumi = FirstNumber[counter] ^ SecondNumber[counter] ^ carryin;
		FinalSum[counter] = sumi
	}

	ActualSum = A + B		
	

	
	
	// Print A & B values above Adder Block
	Middle += "<PRE>"
	Middle += "<BR>"
	Middle += "<IMG SRC = ./../images/blank.gif>"


	//print the gif files
	for (counter = NumDigits-1; counter >= NumDecimals; counter--) 
	{
		if ((FirstNumber[counter] == 0) && (SecondNumber[counter] == 0))
			Middle += "<IMG SRC = ./../images/00.gif>"
		if ((FirstNumber[counter] == 0) && (SecondNumber[counter] == 1))
			Middle += "<IMG SRC = ./../images/01.gif>"
		if ((FirstNumber[counter] == 1) && (SecondNumber[counter] == 0))
			Middle += "<IMG SRC = ./../images/10.gif>"
		if ((FirstNumber[counter] == 1) && (SecondNumber[counter] == 1))
			Middle += "<IMG SRC = ./../images/11.gif>"
	}
	Middle += "<BR>" 

	for (counter = NumDigits-1; counter >= NumDecimals; counter--)
	{
		if (FinalCarry[counter] == 0)
			Middle += "<IMG SRC = ./../images/carry0.gif>"
		else
			Middle += "<IMG SRC = ./../images/carry1.gif>"

		Middle += "<IMG SRC = ./../images/fabox.gif>"
	}
	Middle += "<BR>"


	
	// Print Sum values below Adder Block
	Middle += "<BR>" 
	Middle += "<IMG SRC = ./../images/blank.gif>"
	for (counter = NumDigits-1; counter >= NumDecimals; counter--) 
	{
		if (FinalSum[counter] == 1)
			Middle += "<IMG SRC = ./../images/sum1.gif>"
		else
			Middle += "<IMG SRC = ./../images/sum0.gif>"
	}
	Middle += "<BR>" + "\t   "

	
	Middle +="</PRE>"

	Middle += "<TABLE>"
    Middle += "<TR> <TD>A<TD>"	
    Middle += PrintTwosComp(A, NumDigits)   
	Middle += "<TD>  <TD>  :  " + A + "<br>"
	Middle += "<TR> <TD>B<TD>+"
	Middle += PrintTwosComp(B, NumDigits)	
	Middle += "<TD>  <TD>  :  " + B + "<br>"
	Middle += MakeLine(NumCols + 3)
	Middle += "<TR> <TD>Sum<TD>"	
    Middle += PrintTwosComp(ActualSum, NumDigits)   
	Middle += "<TD>  <TD>  :  <B>" + ActualSum + "</B><br>"
	Middle += "</TABLE><BR><BR>"


	for (counter = NumDecimals; counter <= NumDigits-1; counter++) 
	{
		SumTime[counter]  = 0
		CarryTime[counter] = 0
	}


	// Find all Carry & Sum Related timing things
	for (counter = NumDecimals; counter <= NumDigits-1; counter++) 
	{
		if (counter == 0)
		{
			CarryTime[counter] = CalculateCarryTime(AToCout, CinToCout, 0)
			SumTime[counter]  = CalculateSumTime(AToSum, CinToSum, 0)
		}
		else
		{
			CarryTime[counter] = CalculateCarryTime(AToCout, CinToCout, CarryTime[counter - 1])
			SumTime[counter] = CalculateSumTime(AToSum, CinToSum, CarryTime[counter - 1])
		}
	}



	//Print Sum & carry Times		
	SumTime[NumDigits-1] = 1000 * SumTime[NumDigits-1]
	SumTime[NumDigits-1] = Math.round(SumTime[NumDigits-1])/1000;
	Middle += "Time taken to generate all Sum bits - (" + SumTime[NumDigits-1] + ")units <BR>"
	CarryTime[NumDigits-1] = 1000 * CarryTime[NumDigits-1]
	CarryTime[NumDigits-1] = Math.round(CarryTime[NumDigits-1])/1000
	Middle += "Time taken to generate all Carryout - (" + CarryTime[NumDigits-1] + ")units <BR>"


	Middle += "<BR><BR><HR><BR>Delays to calculate Sum in each bit position <BR><BR>"
	bigwidth = 150 * (NumDigits-NumDecimals)
	
	bigwidth = bigwidth/2
	Middle += "<TABLE BORDER CELLSPACING=4 BORDERCOLOR=#000000 CELLPADDING=7 WIDTH=" + bigwidth +">"
	bigwidth = 100/(NumDigits-NumDecimals);
	Middle += "<P ALIGN=CENTER>"
	Middle += "<TR>"
	Middle += "<TD  VALIGN=TOP WIDTH=" + bigwidth +"><P ALIGN=CENTER> BitNumber </TD>"
	for (counter = NumDigits-1; counter >= NumDecimals; counter--) 
	{
			Middle += "<TD  VALIGN=TOP WIDTH=" + bigwidth +"><P ALIGN=CENTER>" + counter + "</TD>"
	}
	Middle += "</TR>"
	Middle += "<TR>"
	Middle += "<TD  VALIGN=TOP WIDTH=" + bigwidth +"><P ALIGN=CENTER>  SumDelay </TD>"
	for (counter = NumDigits-1; counter >= NumDecimals; counter--) 
	{
			SumTime[counter] = 1000 * SumTime[counter];
            SumTime[counter] = Math.round(SumTime[counter])/1000;   
			Middle += "<TD  VALIGN=TOP WIDTH=" + bigwidth +"><P ALIGN=CENTER>"  + "(" + SumTime[counter] + ")units" + "</TD>"
	}
	Middle += "</TR>"
	Middle += "</P>"
	Middle += "</TABLE>"

	Middle += "<BR>"
	//Middle +="</PRE>"




	
	Bottom = "</BODY> </HTML>";

	if (Overflow)  { Middle = PrintError("Overflow") }
	if (Mixed)     { Middle = PrintError("Mixed numbers") }
	if (NotBinary) { Middle = PrintError("At least one number is non-binary ") }

	parent.frames[1].document.open()
	parent.frames[1].document.write(TheTop);
	parent.frames[1].document.write(Middle);
	parent.frames[1].document.write(Bottom);
	parent.frames[1].document.close()

}



</SCRIPT>
</HEAD>

<BODY bgcolor="#8FC844">

<CENTER> <H2> Ripple Carry Adder</H2> </CENTER>

<FORM>
A: <INPUT type="text" name="A"><P>
B: <INPUT type="text" name="B"><P>

<EM>bin</EM><INPUT type="radio" name="Base" value="Binary" checked>
<EM>dec</EM> <INPUT type="radio" name="Base" value="Decimal"><P>

Number of Bits: <INPUT type="text" name="NumBits" size=4 value=12>
<HR>

<TABLE BORDER>
<CAPTION><B>Signal Delays</B></CAPTION>
<TR>
<TD>A<SUB>i</SUB> to C<SUB>i+1</SUB></TD>
<TD><INPUT type="text" name="AToCout" value=2.2 size=4></TD>
<TD>C<SUB>i</SUB> to C<SUB>i+1</SUB></TD>
<TD><INPUT type="text" name="CinToCout" value=1.9 size=4></TD>
</TR>

<TR>
<TD>C<SUB>i</SUB> to S<SUB>i  </SUB></TD>
<TD><INPUT type="text" name="CinToSum" value=2.5 size=4></TD>
<TD>A<SUB>i</SUB> to S<SUB>i  </SUB></TD>
<TD><INPUT type="text" name="AToSum" value=2.6 size=4></TD>
</TR>
</TABLE>

<p>
<CENTER>
<INPUT type="button" name="enter" value="Compute" onClick="RippleCarryAdd(this.form)">
</CENTER>
</p>

<p>
<CENTER>
<INPUT TYPE="Reset"  VALUE="   Reset   " onClick=parent.frames[1].location.href="../tablet.html">
</CENTER>
</P>

</FORM>


</BODY>
</HTML>
